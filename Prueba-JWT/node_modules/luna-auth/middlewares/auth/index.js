'use strict'

module.exports = (luna) => ({
  initialize() {
    const passportMiddleware = luna.plugins.auth.services.passport.init()

    luna.app.use(passportMiddleware)

    luna.app.use(async (ctx, next) => {
      if (
        ctx.request.header.authorization &&
        ctx.request.header.authorization.split(' ')[0] === 'Bearer'
      ) {
        const token = ctx.request.header.authorization.split(' ')[1]

        const { payload, isValid } = luna.services.token.decodeJwtToken(token)

        if (isValid) {
          //       // request is made by an admin
          const admin = await luna
            .query('user', 'auth')
            .findOne({ id: payload.id }, ['roles'])

          if (!admin || !(admin.isActive === true)) {
            return ctx.forbidden('Invalid credentials')
          }

          ctx.state.admin = admin
          ctx.state.user = admin
          ctx.state.isAuthenticatedAdmin = true
          return next()
        }
      }

      return next()
    })
  }
})
